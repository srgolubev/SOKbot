# SOKbot v1.0

Многофункциональный Telegram-бот для создания и управления проектными листами в Google Sheets с использованием OpenAI API и FastAPI.

## Возможности

- **Создание проектных листов** в Google Sheets на основе шаблонов
- **Интеллектуальный чат-бот** с использованием OpenAI GPT-4o для ответов на вопросы
- **Сохранение контекста беседы** для естественного диалога с пользователем
- **Автоматическое определение типа запроса** (создание таблицы, помощь, чат)
- **Автоматическое форматирование** и расчет сумм в таблицах
- **REST API** для интеграции с другими системами
- **Оптимизированное использование памяти** для работы на серверах с ограниченными ресурсами

## Что нового в версии 1.0

- Добавлена поддержка чат-бота с использованием OpenAI GPT-4o
- Реализовано сохранение контекста беседы для естественного диалога
- Добавлено автоматическое определение типа запроса (создание таблицы, помощь, чат)
- Оптимизировано использование памяти для работы на серверах с ограниченными ресурсами
- Улучшена стабильность работы бота и обработка ошибок

## Архитектура

Система развертывается на двух серверах:
1. **Сервер с доменом** (95.163.234.54) - сервер с доменом srgolubev.ru, на котором настроен Nginx для проксирования webhook-запросов
2. **Сервер с ботом** (212.224.118.58) - сервер, на котором запущен бот в Docker-контейнере

Такая архитектура обеспечивает:
- Безопасное SSL-соединение через Nginx
- Разделение ответственности между серверами
- Возможность масштабирования

## Требования

- Python 3.9+
- Docker и Docker Compose (для контейнеризации)
- Доступ к Google Sheets API
- Telegram Bot Token
- OpenAI API Key (для функций чат-бота и извлечения информации)
- Домен с SSL-сертификатом (для webhook)

## Установка и запуск

Подробная инструкция по установке и настройке находится в файле [DEPLOYMENT.md](DEPLOYMENT.md).

### Локальная установка

1. Клонируйте репозиторий:
```bash
git clone https://github.com/srgolubev/SOKbot.git
cd SOKbot
```

2. Создайте и активируйте виртуальное окружение:
```bash
python -m venv venv
source venv/bin/activate  # На Windows: venv\Scripts\activate
```

3. Установите зависимости:
```bash
pip install -r requirements.txt
```

4. Создайте файл .env с необходимыми переменными окружения:
```
# Telegram Bot API
TELEGRAM_BOT_TOKEN=your_telegram_bot_token

# OpenAI API
OPENAI_API_KEY=your_openai_api_key

# Google Sheets API
SPREADSHEET_ID=your_google_spreadsheet_id
TEMPLATE_TOP_ID=your_template_spreadsheet_id
SOURCE_SHEET_ID=your_source_sheet_id

# Webhook
WEBHOOK_URL=https://your-domain.com/webhook
```
WEBHOOK_SECRET=your_webhook_secret

# OpenAI API Key
OPENAI_API_KEY=your_openai_api_key
```

5. Настройте учетные данные Google API:
   - Создайте проект в [Google Cloud Console](https://console.cloud.google.com/)
   - Включите Google Sheets API
   - Создайте учетные данные OAuth 2.0
   - Сохраните файл `client_secrets.json` в директорию `credentials/`

6. Запустите приложение:
```bash
python app.py
```

### Запуск в Docker

1. Клонируйте репозиторий и перейдите в директорию проекта

2. Настройте переменные окружения и учетные данные Google API как описано выше

3. Запустите контейнер:
```bash
docker-compose up -d
```

## Структура проекта

- `app.py` - Основной файл FastAPI приложения
- `bot/` - Модули бота
  - `command_processor.py` - Обработка команд
  - `sheets_api.py` - Интеграция с Google Sheets API
  - `telegram_webhook.py` - Обработка Telegram вебхуков
- `tests/` - Тесты
- `credentials/` - Директория для учетных данных Google API
- `Dockerfile` и `docker-compose.yml` - Файлы для контейнеризации
- `nginx/` - Конфигурационные файлы Nginx
- `public/` - Статические файлы для веб-сайта
- `scripts/` - Вспомогательные скрипты
  - `check_webhook.sh/ps1` - Скрипты для проверки статуса вебхука
  - `check_website.py` - Скрипт для проверки работоспособности веб-сайта и вебхука
  - `deploy_bot_server.sh` - Скрипт для развертывания сервера с ботом
  - `deploy_domain_server.sh` - Скрипт для развертывания сервера с доменом
  - `fix_domain_server.sh` - Скрипт для исправления проблем на сервере с доменом
  - `fix_html_display.sh` - Скрипт для исправления проблем с отображением HTML-файлов
  - `health_check.py` - Скрипт для проверки здоровья системы
  - `setup_webhook.py` - Скрипт для настройки вебхука
  - `update_domain_server.sh` - Скрипт для обновления сервера с доменом

## Использование

### Функции Telegram бота

#### 1. Создание таблиц

Отправьте боту сообщение в формате:
```
Создай таблицу [Название проекта], добавь разделы: [раздел1], [раздел2], ...
```

Например:
```
Создай таблицу Фестиваль Меда, добавь разделы: судьи, сувенирка, наградная
```

#### 2. Чат-бот с искусственным интеллектом

Вы можете задать боту любой вопрос, и он ответит с помощью OpenAI GPT-4o. Бот автоматически определит, что это обычный вопрос, а не запрос на создание таблицы.

Например:
```
Что такое искусственный интеллект?
```

Бот сохраняет контекст беседы, поэтому вы можете задавать уточняющие вопросы и поддерживать естественный диалог.

#### 3. Помощь

Чтобы получить справку по использованию бота, отправьте команду:
```
/help или Помощь
```

### REST API

POST `/webhook` - Принимает сообщения для обработки:
```json
{
  "message": "Создай таблицу Фестиваль Меда, добавь разделы: судьи, сувенирка, наградная"
}
```

GET `/health` - Проверка работоспособности сервиса

## Версии

### v1.0 (1 апреля 2025)
- Первый полноценный релиз
- Добавлена поддержка чат-бота с использованием OpenAI GPT-4o
- Реализовано сохранение контекста беседы
- Оптимизировано использование памяти

### v0.9 (март 2025)
- Бета-версия с основными функциями создания таблиц

## Авторы

- **Sergey Golubev** - Инициатор и руководитель проекта

## Лицензия

MIT
